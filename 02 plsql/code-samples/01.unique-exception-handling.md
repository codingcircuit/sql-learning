DROP TABLE departments;
CREATE TABLE departments
    ( department_id    NUMBER(4) 
    , department_name  VARCHAR2(30)
    , CONSTRAINT dept_id_uk  		 UNIQUE(department_id)
    ) ;

DROP TABLE departments_rejected;
CREATE TABLE departments_rejected
    ( department_id    NUMBER(4) 
    , department_name  VARCHAR2(30)
    ) ;
    
--select * from departments;
--select * from departments_rejected;


create table deprtment_source as 
select 10 as id,'IT' as name from dual
union all
select 20 as id,'SALES' as name from dual
union all
select 10 as id,'SOFTWARE' as name from dual
;

insert into departments
select * from deprtment_source

/*

-- SQL Statement Error
Error report -
ORA-00001: unique constraint (TEST1.DEPT_ID_UK) violated

-- PLSQL Statement Error
Error starting at line : 74 in command -
BEGIN DATA_INSERT; END;
Error report -
ORA-00001: unique constraint (TEST1.DEPT_ID_UK) violated
ORA-06512: at "TEST1.DATA_INSERT", line 17
ORA-06512: at line 1
00001. 00000 -  "unique constraint (%s.%s) violated"
*Cause:    An UPDATE or INSERT statement attempted to insert a duplicate key.
           For Trusted Oracle configured in DBMS MAC mode, you may see
           this message if a duplicate entry exists at a different level.
*Action:   Either remove the unique restriction or do not insert the key.
*/


CREATE OR REPLACE PROCEDURE sp_unique_exception
IS 
    CURSOR c1 IS SELECT * FROM deprtment_source;
    var1 deprtment_source % rowtype;
    e_unique_records   EXCEPTION;  
    PRAGMA EXCEPTION_INIT (e_unique_records, -1);
    
BEGIN
	OPEN c1;
        LOOP    
            BEGIN	
                FETCH c1 INTO var1;
                EXIT when c1 % notfound;
        
                INSERT INTO departments  VALUES (var1.id, var1.name);        
                COMMIT;
        
            EXCEPTION 
                when e_unique_records then
                INSERT INTO departments_rejected   VALUES (var1.id, var1.name);
                when others then
                raise;
                
            END;        
        END LOOP;
    CLOSE c1;
END;


execute sp_unique_exception;
